DECLARE @FIELD_NAME VARCHAR(10), @FLD_DATE DATETIME, @FLD_WEF DATETIME, @FLD_CALC VARCHAR(8000), @FLD_VALID VARCHAR(8000)
SET @FLD_WEF = '2019-04-01'

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'STD'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MIN(MAX({TAX_GROSSP}+{SAL_PRVEMP}-{PRJ_PTAX}-{PT_PRVEMP},0),50000)+{PRJ_PTAX}+{PT_PRVEMP}'
IF EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='PRV_PTAX') 
	SET @FLD_CALC = REPLACE(@FLD_CALC,'{PT_PRVEMP}',+'{PRV_PTAX}')
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'STD_CUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MIN(MAX({TAX_GROSSP}-{PRJ_PTAX},0),50000)+{PRJ_PTAX}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_REBATE'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=500000,MIN({TOTAL_TAX},12500),0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M,CREATEDBY,UPDATEDBY) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1,'SA','SA')
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_REBCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCCUR}<=500000,MIN({TOT_TAXCUR},12500),0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M,CREATEDBY,UPDATEDBY) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1,'SA','SA')
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

