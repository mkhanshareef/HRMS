DECLARE @FIELD_NAME VARCHAR(10), @FLD_DATE DATETIME, @FLD_WEF DATETIME, @FLD_CALC VARCHAR(8000), @FLD_VALID VARCHAR(8000)
SET @FLD_WEF = '2018-04-01'

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_CONV'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = '{PRJ_CONV}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_MED'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = '{PRJ_MED}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'STD'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MIN(MAX({TAX_GROSSP}+{SAL_PRVEMP}-{PRJ_PTAX}-{PT_PRVEMP},0),40000)+{PRJ_PTAX}+{PT_PRVEMP}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'STD_CUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MIN(MAX({TAX_GROSSP}-{PRJ_PTAX},0),40000)+{PRJ_PTAX}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_VI'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
--SET @FLD_CALC = '{DEDU_80C}+MIN({DEDU_80CCD},50000)+MIN({DEDU_80D},25000)+MIN({DEDU_80DP},25000)+MIN({DEDU_80DPS},25000)+MIN({DEDU_80DD},125000)+MIN({DEDU_80DDB},60000)+{DEDU_80E}+MIN({DEDU_80EE},50000)+{DEDU_80G}+{DEDU_80GG}+MIN({DEDU_80TTA},10000)+MIN({DEDU_80U},125000)'
SET @FLD_CALC = REPLACE(REPLACE(REPLACE(@FLD_CALC,'MIN({DEDU_80DPS},5000)','MIN({DEDU_80DPS},25000)'),'MIN({DEDU_80DDB},60000)','MIN({DEDU_80DDB},100000)'),'MIN({DEDU_80TTA},10000)','MIN({DEDU_80TTA},50000)')
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_VICUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = REPLACE(REPLACE(REPLACE(@FLD_CALC,'MIN({DEDU_80DPS},5000)','MIN({DEDU_80DPS},25000)'),'MIN({DEDU_80DDB},60000)','MIN({DEDU_80DDB},100000)'),'MIN({DEDU_80TTA},10000)','MIN({DEDU_80TTA},50000)')
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'CESS'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({TOTAL_TAX}-{TAX_REBATE}+{SURCHARGE},0)*0.04'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'CESSCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({TOT_TAXCUR}-{TAX_REBCUR}+{SURCHCUR},0)*0.04'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'CESSPM'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TDS_CAL}=''N'',0,MIN(MAX({CESS}-{CES_DEDUCT},0),({TAX_PERMON}+{ADDTAX})*4/104))+GETTRN([A],[CESSPM])'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'ADDTAX'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
--SET @FLD_CALC = 'MAX(MAX({TOTAL_TAX}+{SURCHARGE}+{CESS}-{TAX_REBATE}-{TAX_DEDUCT}-{TAX_PRVEMP},0)-MAX(MAX(({TDS_RTI}+IIF({TAX_RTI}<=5000000,0,MIN({TDS_RTI}+{TDS_RTI}*IIF({TAX_RTI}<=10000000,0.10,0.15),(IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,112500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,110000,100000))+(IIF({TAX_RTI}<=10000000,5000000,10000000)-1000000)*0.30)*IIF({TAX_RTI}<=10000000,1,1.1)+({TAX_RTI}-IIF({TAX_RTI}<=10000000,5000000,10000000)))-{TDS_RTI}))-IIF({TAX_RTI}<=350000,MIN({TDS_RTI},2500),0),0)*1.04-{TAX_DEDUCT}-{TAX_PRVEMP},0),0)'
SET @FLD_CALC = REPLACE(@FLD_CALC,'*1.03','*1.04')
SET @FLD_VALID = '{ONETIMEPAY}>0'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE
