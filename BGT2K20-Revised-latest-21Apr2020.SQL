ALTER TABLE Formula DISABLE TRIGGER ALL
ALTER TABLE PaySetup DISABLE TRIGGER ALL
ALTER TABLE Formula ALTER COLUMN Fld_Calc VarChar(4000) NULL
ALTER TABLE PaySetup ALTER COLUMN Field_Desc VarChar(200) NULL
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PaySetup]') AND Name = 'Field_InpMode') BEGIN
	ALTER TABLE PaySetup ADD Field_InpMode VarChar(1) NULL
END
GO
EXEC ('UPDATE PaySetup SET Field_InpMode=Field_Type WHERE Field_InpMode IS NULL')
GO
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE Field_Name='PFSAL') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO AS SNO, REPLACE(Field_Name,'SPLALL','PFSAL') AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'PF SALARY' AS PRINT_NAME, 'PF Salary' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP (NOLOCK)
	WHERE Field_Name LIKE '%SPLALL' AND REPLACE(Field_Name,'SPLALL','PFSAL') NOT IN (SELECT Field_Name FROM PaySetup WHERE Field_Name LIKE '%PFSAL')
END
IF NOT EXISTS(SELECT * FROM FORMULA (NOLOCK) WHERE Field_Name='PFSAL') BEGIN
	INSERT INTO Formula (FIELD_NAME, FLD_DATE, FLD_WEF, FLD_CALC, FLD_VALID, FLD_RND, FLD_RND_M)
	SELECT REPLACE(Field_Name,'SPLALL','PFSAL') AS FIELD_NAME, FLD_DATE, FLD_WEF, 
		REPLACE(FLD_CALC,'SPLALL','PFSAL') AS FLD_CALC, REPLACE(FLD_VALID,'SPLALL','PFSAL') AS  FLD_VALID, 2 AS FLD_RND, 1 AS FLD_RND_M
	FROM Formula (NOLOCK)
	WHERE Field_Name LIKE '%SPLALL' AND REPLACE(Field_Name,'SPLALL','PFSAL') NOT IN (SELECT Field_Name FROM Formula WHERE Field_Name LIKE '%PFSAL') AND Field_Name<>'SPLALL'
	INSERT INTO Formula (FIELD_NAME, FLD_DATE, FLD_WEF, FLD_CALC, FLD_VALID, FLD_RND, FLD_RND_M)
	SELECT 'PFSAL' AS FIELD_NAME, FLD_DATE, FLD_WEF,
		REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(Fld_Calc,'ERN_',''),'+GETTRN([A],[PFSALARY])',''),'6500)','6500*12)'),'15000)','15000*12)'),'/12/{MONDAYS}*{PAYDAYS}',''),'/12','') AS FLD_CALC, NULL AS FLD_VALID,
		FLD_RND, FLD_RND_M
	FROM Formula
	WHERE Field_Name='PFSALARY'
END
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'PFSAL') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD PFSAL NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'ARR_PFSAL') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD ARR_PFSAL NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'ERN_PFSAL') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD ERN_PFSAL NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'YTD_PFSAL') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD YTD_PFSAL NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'PRJ_PFSAL') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD PRJ_PFSAL NUMERIC(15,2)

IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE Field_Name='NPSE') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO AS SNO, REPLACE(Field_Name,'SPLALL','NPSE') AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'NPS EMP' AS PRINT_NAME, 'NPS (Employee)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP (NOLOCK)
	WHERE Field_Name LIKE '%SPLALL' AND REPLACE(Field_Name,'SPLALL','NPSE') NOT IN (SELECT Field_Name FROM PaySetup WHERE Field_Name LIKE '%NPSE')
END
IF NOT EXISTS(SELECT * FROM FORMULA (NOLOCK) WHERE Field_Name LIKE '%NPSE') BEGIN
	INSERT INTO Formula (FIELD_NAME, FLD_DATE, FLD_WEF, FLD_CALC, FLD_VALID, FLD_RND, FLD_RND_M)
	SELECT REPLACE(Field_Name,'SPLALL','NPSE') AS FIELD_NAME, FLD_DATE, FLD_WEF, 
		REPLACE(FLD_CALC,'SPLALL','NPSE') AS FLD_CALC, REPLACE(FLD_VALID,'SPLALL','NPSE') AS  FLD_VALID, 2 AS FLD_RND, 1 AS FLD_RND_M
	FROM Formula (NOLOCK)
	WHERE Field_Name LIKE '%SPLALL' AND REPLACE(Field_Name,'SPLALL','NPSE') NOT IN (SELECT Field_Name FROM Formula WHERE Field_Name LIKE '%NPSE') AND Field_Name<>'SPLALL'
END
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'NPSE') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD NPSE NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'ARR_NPSE') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD ARR_NPSE NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'ERN_NPSE') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD ERN_NPSE NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'YTD_NPSE') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD YTD_NPSE NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'PRJ_NPSE') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD PRJ_NPSE NUMERIC(15,2)

IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE Field_Name='NPSC') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO AS SNO, REPLACE(Field_Name,'SPLALL','NPSC') AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'NPS COMP' AS PRINT_NAME, 'NPS (Employeer)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP (NOLOCK)
	WHERE Field_Name LIKE '%SPLALL' AND REPLACE(Field_Name,'SPLALL','NPSC') NOT IN (SELECT Field_Name FROM PaySetup WHERE Field_Name LIKE '%NPSC')
END
IF NOT EXISTS(SELECT * FROM FORMULA (NOLOCK) WHERE Field_Name LIKE '%NPSC') BEGIN
	INSERT INTO Formula (FIELD_NAME, FLD_DATE, FLD_WEF, FLD_CALC, FLD_VALID, FLD_RND, FLD_RND_M)
	SELECT REPLACE(Field_Name,'SPLALL','NPSC') AS FIELD_NAME, FLD_DATE, FLD_WEF, 
		REPLACE(FLD_CALC,'SPLALL','NPSC') AS FLD_CALC, REPLACE(FLD_VALID,'SPLALL','NPSC') AS  FLD_VALID, 2 AS FLD_RND, 1 AS FLD_RND_M
	FROM Formula (NOLOCK)
	WHERE Field_Name LIKE '%SPLALL' AND REPLACE(Field_Name,'SPLALL','NPSC') NOT IN (SELECT Field_Name FROM Formula WHERE Field_Name LIKE '%NPSC') AND Field_Name<>'SPLALL'
END
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'NPSC') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD NPSC NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'ARR_NPSC') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD ARR_NPSC NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'ERN_NPSC') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD ERN_NPSC NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'YTD_NPSC') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD YTD_NPSC NUMERIC(15,2)
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'PRJ_NPSC') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD PRJ_NPSC NUMERIC(15,2)

UPDATE PaySetup SET Field_Desc='Bonus' WHERE Field_Name='CTC_BONUS' AND Field_Desc='NPS Employer Contribution'
UPDATE PaySetup SET Field_Desc='Superannuation Fund' WHERE Field_Name LIKE '%SAF' AND Field_Desc='NPS Employer Contribution'
UPDATE PaySetup SET Field_Desc='Superannuation Fund (Y/N)' WHERE Field_Name='SAF_YN' AND Field_Desc='NPS Employer Contribution'
UPDATE PaySetup SET Field_Desc='Superannuation Fund (%)' WHERE Field_Name='SAF_PER' AND Field_Desc='NPS Employer Contribution'

IF NOT EXISTS(SELECT * FROM PaySetup WHERE Field_Name='DEDU_80CCD')
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'DEDU_80CCD' AS FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, 
			'80CCD(1)' AS PRINT_NAME, 
			'80CCD(1) National Pension Scheme (Employee Contribution)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='DEDU_80CCC'
ELSE
	UPDATE PAYSETUP SET FIELD_DESC='80CCD(1) National Pension Scheme (Employee Contribution)',PRINT_NAME='80CCD(1)' WHERE Field_Name='DEDU_80CCD'
GO

IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'DEDU_80CCD') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD DEDU_80CCD NUMERIC(15,2)
GO

IF NOT EXISTS(SELECT * FROM PaySetup WHERE Field_Name='DEDU_80CD1')
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'DEDU_80CD1' AS FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, 
			'80CCD(1B)' AS PRINT_NAME, 
			'80CCD(1B) National Pension Scheme (Employee Contribution)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='DEDU_80CCD'
ELSE
	UPDATE PAYSETUP SET FIELD_DESC='80CCD(1B) National Pension Scheme (Employee Contribution)',PRINT_NAME='80CCD(1b)' WHERE Field_Name='DEDU_80CD1'
GO

IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'DEDU_80CD1') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD DEDU_80CD1 NUMERIC(15,2)
GO

IF NOT EXISTS(SELECT * FROM PaySetup WHERE Field_Name='DEDU_80CD2')
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'DEDU_80CD2' AS FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, 
			'80CCD(2)' AS PRINT_NAME, 
			'80CCD(2) National Pension Scheme (Employer Contribution)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='DEDU_80CCD'
ELSE
	UPDATE PAYSETUP SET FIELD_DESC='80CCD(2) National Pension Scheme (Employer Contribution)',PRINT_NAME='80CCD(2)' WHERE Field_Name='DEDU_80CD2'
GO

IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'DEDU_80CD2') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD DEDU_80CD2 NUMERIC(15,2)
GO
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TaxCalBase') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO+1 AS SNO, 'TaxCalBase' AS FIELD_NAME, FIELD_TYPE, 'L' AS Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TaxCalBase' AS PRINT_NAME, 'Tax Calculation Based On' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, 'Y' AS FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TDS_CAL'
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TAXOTR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'TAXOTR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TAX OTR' AS PRINT_NAME, 'Tax on Income (Old Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TOTAL_TAX'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'TAXOTR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='TOTAL_TAX') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TAXOTRCUR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'TAXOTRCUR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TAXOTRCUR' AS PRINT_NAME, 'Tax on Current Employer Income (Old Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TOTAL_TAX'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'TAXOTRCUR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='TOTAL_TAX') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TAXNTR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'TAXNTR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TAX NTR' AS PRINT_NAME, 'Tax on Income (New Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TOTAL_TAX'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'TAXNTR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='TOTAL_TAX') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TAXNTRCUR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'TAXNTRCUR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TAXNTRCUR' AS PRINT_NAME, 'Tax on Current Employer Income (New Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TOTAL_TAX'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'TAXNTRCUR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='TOTAL_TAX') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TDS_RTIOTR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'TDS_RTIOTR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TDS_RTIOTR' AS PRINT_NAME, 'Tax on Reccuring Income (Old Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TDS_RTI'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'TDS_RTIOTR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='TDS_RTI') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='TDS_RTINTR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'TDS_RTINTR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'TDS_RTINTR' AS PRINT_NAME, 'Tax on Reccuring Income (New Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TDS_RTI'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'TDS_RTINTR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='TDS_RTI') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='SUROTR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'SUROTR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'SUR OTR' AS PRINT_NAME, 'Surcharge on Tax (Old Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='SURCHARGE'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'SUROTR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='SURCHARGE') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='SUROTRCUR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'SUROTRCUR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'SUROTRCUR' AS PRINT_NAME, 'Surcharge on Current Employer Tax (Old Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='SURCHARGE'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'SUROTRCUR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='SURCHARGE') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='SURNTR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'SURNTR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'SUR NTR' AS PRINT_NAME, 'Surcharge on Tax (New Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='SURCHARGE'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'SURNTR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='SURCHARGE') 
END
IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='SURNTRCUR') BEGIN
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO, 'SURNTRCUR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
			'SURNTRCUR' AS PRINT_NAME, 'Surcharge on Current Employer Tax (New Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='SURCHARGE'
	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'SURNTRCUR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='SURCHARGE') 
END
--SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name LIKE '%PF%'
--IF NOT EXISTS(SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='PRJ_PF') BEGIN
--	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
--				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
--				FLD_PAYHIST, FLD_DEFAULT)
--	SELECT SNO, 'SURNTRCUR' AS FIELD_NAME, FIELD_TYPE, Field_InpMode, FIELD_LEN, FIELD_DEC, 
--			'SURNTRCUR' AS PRINT_NAME, 'Surcharge on Current Employer Tax (New Tax Regime)' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
--			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 'N' AS FLD_PAYHIST, FLD_DEFAULT
--	FROM PAYSETUP
--	WHERE Field_Name='SURCHARGE'
--	UPDATE PaySetup SET SNo=SNo+1 WHERE Field_Name<>'SURNTRCUR' AND SNo>=(SELECT SNO FROM PaySetup (NOLOCK) WHERE Field_Name='SURCHARGE') 
--END
--SELECT * FROM PaySetup (NOLOCK) WHERE  Field_Name='OTHER_PERK'
UPDATE PaySetup SET Field_Desc='Other Benefits or Amenities' WHERE Field_Name='OTHER_PERK'

--ALTER TABLE Formula ENABLE TRIGGER ALL
--ALTER TABLE PaySetup ENABLE TRIGGER ALL
GO

DECLARE @FIELD_NAME VARCHAR(10), @FLD_DATE DATETIME, @FLD_WEF DATETIME, @FLD_CALC VARCHAR(8000), @FLD_VALID VARCHAR(8000)
SET @FLD_WEF = '2020-04-01'

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_HRA'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE<@FLD_WEF ORDER BY FLD_DATE DESC
IF @FLD_CALC IS NULL SET @FLD_CALC = 'TAXABLEHRA([{ERN_BASIC}+{ERN_FDA}+{ERN_VDA}])+GETTRN([A],[TAX_HRA])'
SET @FLD_CALC = REPLACE('IIF({TAXCALBASE}=''N'',{PRJ_HRA},@FLD_CALC)','@FLD_CALC',@FLD_CALC)
IF NOT EXISTS(SELECT * FROM FORMULA (NOLOCK) WHERE Field_Name=@FIELD_NAME AND FLD_DATE=@FLD_WEF)
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_WEF

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_LTA'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
IF @FLD_CALC IS NULL SET @FLD_CALC = '{PRJ_LTA}-GETRIM([RIM_LTARIM],[C],[{@FY_START}],[{@FY_END}])+GETTRN([A],[TAX_LTA])'
SET @FLD_CALC = REPLACE('IIF({TAXCALBASE}=''N'',{PRJ_LTA},@FLD_CALC)','@FLD_CALC',@FLD_CALC)
IF NOT EXISTS(SELECT * FROM FORMULA (NOLOCK) WHERE Field_Name=@FIELD_NAME AND FLD_DATE=@FLD_WEF)
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_WEF

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'OTHER_PERK'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({YTD_PF}+ROUND(({PFSAL}/12.00)*12.00/100.00,0)*{MON_LEFT}+{PRJ_SAF}+{PRJ_NPSC}-750000,0)'
IF CHARINDEX('/12',(SELECT TOP 1 Fld_Calc FROM Formula (NOLOCK) WHERE Field_Name='PFSAL' ORDER BY Fld_Date DESC))>0
	SET @FLD_CALC = REPLACE(@FLD_CALC,'{PFSAL}/12.00','{PFSAL}')
IF NOT EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='PRJ_SAF') 
	SET @FLD_CALC = REPLACE(@FLD_CALC,'+{PRJ_SAF}','')
IF EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='PRJ_NPS') 
	SET @FLD_CALC = REPLACE(@FLD_CALC,'+{PRJ_NPSC}','+{PRJ_NPS}')
IF NOT EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='PRJ_NPSC') 
	SET @FLD_CALC = REPLACE(@FLD_CALC,'+{PRJ_NPSC}','')
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

IF EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='TAX_SAF') AND EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='PRJ_SAF') BEGIN
	SET @FLD_DATE = NULL
	SET @FIELD_NAME = 'TAX_SAF'
	SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
	FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
	SET @FLD_CALC = '{PRJ_SAF}'
		IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
			INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
						(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
		ELSE
			UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

	SET @FLD_DATE = NULL
	SET @FIELD_NAME = 'PRJ_GROSSP'
	SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
	FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
	SET @FLD_CALC = REPLACE(REPLACE(@FLD_CALC,'+{PRJ_SAF}',''),'+{TAX_SAF}','')
	IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
		INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
	ELSE
		UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

	SET @FLD_DATE = NULL
	SET @FIELD_NAME = 'TAX_GROSSP'
	SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
	FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
	SET @FLD_CALC = REPLACE(REPLACE(@FLD_CALC,'+{PRJ_SAF}',''),'+{TAX_SAF}','')
	IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
		INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
	ELSE
		UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE
END

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'INC_IHP'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({INC_IHP}<-200000,-200000,{INC_IHP})'
SET @FLD_VALID = '{INC_IHP}>0 OR {TAXCALBASE}<>''N'''
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'STD'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',0,MIN(MAX({TAX_GROSSP}+{SAL_PRVEMP}-{PRJ_PTAX}-{PT_PRVEMP},0),50000))+{PRJ_PTAX}+{PT_PRVEMP}'
IF EXISTS(SELECT Field_Name FROM PaySetup (NOLOCK) WHERE Field_Name='PRV_PTAX') 
	SET @FLD_CALC = REPLACE(@FLD_CALC,'{PT_PRVEMP}','{PRV_PTAX}')
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'STD_CUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',0,MIN(MAX({TAX_GROSSP}-{PRJ_PTAX},0),50000))+{PRJ_PTAX}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'INV_TOTAL'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE<=@FLD_WEF ORDER BY FLD_DATE DESC
IF CHARINDEX('{DEDU_80CCD}', @FLD_CALC) = 0 BEGIN
	SET @FLD_CALC = REPLACE(@FLD_CALC, '{DEDU_80CCC}+', '{DEDU_80CCC}+{DEDU_80CCD}+')
END
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_TOTAL'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE<=@FLD_WEF ORDER BY FLD_DATE DESC
SET @FLD_CALC = '{DEDU_80C}+{DEDU_80CD1}+{DEDU_80CD2}+{DEDU_80D}+{DEDU_80DP}+{DEDU_80DPS}+{DEDU_80DD}+{DEDU_80DDB}+{DEDU_80E}+{DEDU_80EE}+{DEDU_80G}+{DEDU_80GG}+{DEDU_80TTA}+{DEDU_80U}'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_80C'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',0,MIN({INV_TOTAL}+{PF_PRVEMP},150000))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_80CCU'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',0,MIN({INV_TOTAL},150000))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_VI'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = '{DEDU_80CD2}+IIF({TAXCALBASE}=''N'',0,{DEDU_80C}+MIN({DEDU_80CD1},50000)+MIN({DEDU_80D},25000)+MIN(MIN({DEDU_80DP},25000)+MIN({DEDU_80DPS},50000),50000)+MIN({DEDU_80DD},125000)+MIN({DEDU_80DDB},100000)+{DEDU_80E}+{DEDU_80G}+{DEDU_80GG}+MIN({DEDU_80TTA},10000)+MIN({DEDU_80U},125000))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'DEDU_VICUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = '{DEDU_80CD2}+IIF({TAXCALBASE}=''N'',0,{DEDU_80CCU}+MIN({DEDU_80CD1},50000)+MIN({DEDU_80D},25000)+MIN(MIN({DEDU_80DP},25000)+MIN({DEDU_80DPS},50000),50000)+MIN({DEDU_80DD},125000)+MIN({DEDU_80DDB},100000)+{DEDU_80E}+{DEDU_80G}+{DEDU_80GG}+MIN({DEDU_80TTA},10000)+MIN({DEDU_80U},125000))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_INCOME'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({TAX_GROSSP}+{SAL_PRVEMP}-IIF({TAXCALBASE}=''N'',0,{STD})+{TAX_OTHER}-{DEDU_VI},0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_INCCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({TAX_GROSSP}-IIF({TAXCALBASE}=''N'',0,{STD_CUR})+{TAX_OTHER}-{DEDU_VICUR},0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAXOTR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME='TOTAL_TAX' ORDER BY FLD_DATE DESC
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAXOTRCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME='TOT_TAXCUR' ORDER BY FLD_DATE DESC
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAXNTR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)),0,IIF({TAX_INCOME}<=500000,({TAX_INCOME}-IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)))*0.05,IIF({TAX_INCOME}<=750000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+({TAX_INCOME}-500000)*0.10,IIF({TAX_INCOME}<=1000000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+({TAX_INCOME}-750000)*0.15,IIF({TAX_INCOME}<=1250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+({TAX_INCOME}-1000000)*0.20,IIF({TAX_INCOME}<=1500000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+({TAX_INCOME}-1250000)*0.25,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+62500+({TAX_INCOME}-1500000)*0.3))))))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAXNTRCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME='TOT_TAXCUR' ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCCUR}<=IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)),0,IIF({TAX_INCCUR}<=500000,({TAX_INCCUR}-IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)))*0.05,IIF({TAX_INCCUR}<=750000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+({TAX_INCCUR}-500000)*0.10,IIF({TAX_INCCUR}<=1000000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+({TAX_INCCUR}-750000)*0.15,IIF({TAX_INCCUR}<=1250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+({TAX_INCCUR}-1000000)*0.20,IIF({TAX_INCCUR}<=1500000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+({TAX_INCCUR}-1250000)*0.25,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+62500+({TAX_INCCUR}-1500000)*0.3))))))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TOTAL_TAX'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',{TAXNTR},{TAXOTR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TOT_TAXCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',{TAXNTRCUR},{TAXOTRCUR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SUROTR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=5000000,0,MIN({TOTAL_TAX}+{TOTAL_TAX}*IIF({TAX_INCOME}<=10000000,0.10,IIF({TAX_INCOME}<=20000000,0.15,IIF({TAX_INCOME}<=50000000,0.25,0.37))),(IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,112500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,110000,100000))+(IIF({TAX_INCOME}<=10000000,5000000,IIF({TAX_INCOME}<=20000000,10000000,IIF({TAX_INCOME}<=50000000,20000000,50000000)))-1000000)*0.30)*IIF({TAX_INCOME}<=10000000,1,IIF({TAX_INCOME}<=20000000,1.1,IIF({TAX_INCOME}<=50000000,1.15,1.25)))+({TAX_INCOME}-IIF({TAX_INCOME}<=10000000,5000000,IIF({TAX_INCOME}<=20000000,10000000,IIF({TAX_INCOME}<=50000000,20000000,50000000)))))-{TOTAL_TAX})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SUROTRCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME='SURCHCUR' ORDER BY FLD_DATE DESC
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURNTR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=5000000,0,MIN({TOTAL_TAX}+{TOTAL_TAX}*IIF({TAX_INCOME}<=10000000,0.10,IIF({TAX_INCOME}<=20000000,0.15,IIF({TAX_INCOME}<=50000000,0.25,0.37))),(IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+62500+(IIF({TAX_INCOME}<=10000000,5000000,IIF({TAX_INCOME}<=20000000,10000000,IIF({TAX_INCOME}<=50000000,20000000,50000000)))-1000000)*0.30)*IIF({TAX_INCOME}<=10000000,1,IIF({TAX_INCOME}<=20000000,1.1,IIF({TAX_INCOME}<=50000000,1.15,1.25)))+({TAX_INCOME}-IIF({TAX_INCOME}<=10000000,5000000,IIF({TAX_INCOME}<=20000000,10000000,IIF({TAX_INCOME}<=50000000,20000000,50000000)))))-{TOTAL_TAX})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURNTRCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCCUR}<=5000000,0,MIN({TOT_TAXCUR}+{TOT_TAXCUR}*IIF({TAX_INCCUR}<=10000000,0.10,IIF({TAX_INCCUR}<=20000000,0.15,IIF({TAX_INCCUR}<=50000000,0.25,0.37))),(IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+62500+(IIF({TAX_INCCUR}<=10000000,5000000,IIF({TAX_INCCUR}<=20000000,10000000,IIF({TAX_INCCUR}<=50000000,20000000,50000000)))-1000000)*0.30)*IIF({TAX_INCCUR}<=10000000,1,IIF({TAX_INCCUR}<=20000000,1.1,IIF({TAX_INCCUR}<=50000000,1.15,1.25)))+({TAX_INCCUR}-IIF({TAX_INCCUR}<=10000000,5000000,IIF({TAX_INCCUR}<=20000000,10000000,IIF({TAX_INCCUR}<=50000000,20000000,50000000)))))-{TOT_TAXCUR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE


SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURCHARGE'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',{SURNTR},{SUROTR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURCHCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',{SURNTRCUR},{SUROTRCUR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TDS_RTIOTR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME='TDS_RTI' AND FLD_DATE<@FLD_WEF ORDER BY FLD_DATE DESC
IF @FLD_CALC IS NULL SET @FLD_CALC = 'IIF({TAX_RTI}<=IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)),0,IIF({TAX_RTI}<=500000,({TAX_RTI}-IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)))*0.05,IIF({TAX_RTI}<=1000000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+({TAX_RTI}-500000)*0.20,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,112500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,110000,100000))+({TAX_RTI}-1000000)*0.30)))'
IF (@FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF) AND NOT EXISTS(SELECT * FROM FORMULA (NOLOCK) WHERE FIELD_NAME='TDS_RTIOTR')
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TDS_RTINTR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_RTI}<=IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)),0,IIF({TAX_RTI}<=500000,({TAX_RTI}-IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,300000,500000)))*0.05,IIF({TAX_RTI}<=0750000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+({TAX_RTI}-500000)*0.10,IIF({TAX_RTI}<=1000000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+({TAX_RTI}-750000)*0.15,IIF({TAX_RTI}<=1250000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+({TAX_RTI}-1000000)*0.20,IIF({TAX_RTI}<=1500000,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+({TAX_RTI}-1250000)*0.25,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<60,12500,IIF(MONDIFF([{DOB}],[{@FY_END}])/12<80,10000,0))+25000+37500+50000+62500+({TAX_RTI}-1500000)*0.3))))))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TDS_RTI'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAXCALBASE}=''N'',{TDS_RTINTR},{TDS_RTIOTR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'ADDTAX'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA (NOLOCK) WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MIN(MAX(MAX({TOTAL_TAX}-{TAX_REBATE},0)+{SURCHARGE}+{CESS}-MAX({TDS_RTI}-{TAX_REBATE},0)*(1+{SURCHARGE}/{TOTAL_TAX})*1.04,0),MAX({TOTAL_TAX}-{TAX_REBATE}+{SURCHARGE}+{CESS}-{TAX_DEDUCT}-{TAX_PRVEMP},0))'
SET @FLD_VALID = '{ONETIMEPAY}>0 AND {TOTAL_TAX}>0'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

ALTER TABLE Formula ENABLE TRIGGER ALL
ALTER TABLE PaySetup ENABLE TRIGGER ALL
