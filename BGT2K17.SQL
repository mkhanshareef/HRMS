IF NOT EXISTS(SELECT * FROM PaySetup WHERE Field_Name='TAX_RTI')
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO+1 AS SNO, 'TAX_RTI' AS FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, 
			'RTI' AS PRINT_NAME, 
			'Recurring Taxable Income' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TAX_INCOME'
GO
IF NOT EXISTS(SELECT * FROM PaySetup WHERE Field_Name='TDS_RTI')
	INSERT INTO PAYSETUP (SNO, FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, PRINT_NAME, FIELD_DESC, 
				FLD_CATEG, FLD_RATED, FLD_MONTH, FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, 
				FLD_PAYHIST, FLD_DEFAULT)
	SELECT SNO+1 AS SNO, 'TDS_RTI' AS FIELD_NAME, FIELD_TYPE, FIELD_LEN, FIELD_DEC, 
			'TDS ON RTI' AS PRINT_NAME, 
			'TDS on Recurring Taxable Income' AS FIELD_DESC, FLD_CATEG, FLD_RATED, FLD_MONTH,	
			FLD_HRDMAST, FLD_INCREMENT, FLD_PAYMAST, FLD_HRDHIST, FLD_PAYHIST, FLD_DEFAULT
	FROM PAYSETUP
	WHERE Field_Name='TOTAL_TAX'
GO

IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'TAX_RTI') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD TAX_RTI NUMERIC(15,2)
GO
IF NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'TDS_RTI') AND NOT EXISTS(SELECT * FROM syscolumns WHERE Id = Object_Id(N'[PayHist]') AND Name = 'Field_Name')
	ALTER TABLE PayHist ADD TDS_RTI NUMERIC(15,2)
GO
IF (SELECT SNo FROM PaySetup WHERE Field_Name='TAX_INCOME')<(SELECT SNo FROM PaySetup WHERE Field_Name='ONETIMEPAY')
	UPDATE PaySetup SET SNo=(SELECT SNo-1 FROM PaySetup WHERE Field_Name='TAX_INCOME') WHERE Field_Name='ONETIMEPAY'

--SELECT * FROM PaySetup WHERE Field_Name IN ('TAX_INCOME','ONETIMEPAY','TOTAL_TAX','TDS','ITAX','SURCH','CESSPM','ADDTAX') ORDER BY SNo
DECLARE @FIELD_NAME VARCHAR(10), @FLD_DATE DATETIME, @FLD_WEF DATETIME, @FLD_CALC VARCHAR(8000), @FLD_VALID VARCHAR(8000)
SET @FLD_WEF = '2017-04-01'

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TOTAL_TAX'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,250000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,300000,500000)),0,IIF({TAX_INCOME}<=500000,({TAX_INCOME}-IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,250000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,300000,500000)))*0.05,IIF({TAX_INCOME}<=1000000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,12500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,10000,0))+({TAX_INCOME}-500000)*0.2,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,112500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,110000,100000))+({TAX_INCOME}-1000000)*0.3)))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TOT_TAXCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCCUR}<=IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,250000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,300000,500000)),0,IIF({TAX_INCCUR}<=500000,({TAX_INCCUR}-IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,250000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,300000,500000)))*0.05,IIF({TAX_INCCUR}<=1000000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,12500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,10000,0))+({TAX_INCCUR}-500000)*0.2,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,112500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,110000,100000))+({TAX_INCCUR}-1000000)*0.3)))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_REBATE'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=350000,MIN({TOTAL_TAX},2500),0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_REBCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCCUR}<=350000,MIN({TOTAL_TAX},2500),0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURCHARGE'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCOME}<=5000000,0,MIN({TOTAL_TAX}+{TOTAL_TAX}*IIF({TAX_INCOME}<=10000000,0.10,0.15),IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,112500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,110000,100000))+(IIF({TAX_INCOME}<=10000000,5000000,10000000)-1000000)*0.30+({TAX_INCOME}-IIF({TAX_INCOME}<=10000000,5000000,10000000)))-{TOTAL_TAX})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURCHCUR'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_INCCUR}<=5000000,0,MIN({TOT_TAXCUR}+{TOT_TAXCUR}*IIF({TAX_INCCUR}<=10000000,0.10,0.15),IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,112500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,110000,100000))+(IIF({TAX_INCCUR}<=10000000,5000000,10000000)-1000000)*0.30+({TAX_INCCUR}-IIF({TAX_INCCUR}<=10000000,5000000,10000000)))-{TOT_TAXCUR})'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'SURCH'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TDS_CAL}=''N'',0,MIN(MAX({SURCHARGE}-{SUR_DEDUCT},0),({TAX_PERMON}+{ADDTAX}-{CESSPM})*IIF({TAX_INCOME}<=5000000,0,IIF({TAX_INCOME}<=10000000,10/110,15/115))))+GETTRN([A],[SURCH])'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TAX_RTI'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({TAX_INCOME}-{ONETIMEPAY},0)'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'TDS_RTI'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'IIF({TAX_RTI}<=IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,250000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,300000,500000)),0,IIF({TAX_RTI}<=500000,({TAX_RTI}-IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,250000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,300000,500000)))*0.05,IIF({TAX_RTI}<=1000000,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,12500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,10000,0))+({TAX_RTI}-500000)*0.20,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,112500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,110000,100000))+({TAX_RTI}-1000000)*0.30)))'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
				(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

SET @FLD_DATE = NULL
SET @FIELD_NAME = 'ADDTAX'
SELECT TOP 1 @FLD_DATE=FLD_DATE, @FLD_CALC=FLD_CALC, @FLD_VALID=FLD_VALID 
FROM FORMULA WHERE FIELD_NAME=@FIELD_NAME ORDER BY FLD_DATE DESC
SET @FLD_CALC = 'MAX({TOTAL_TAX}+{SURCHARGE}+{CESS}-{TAX_REBATE},0)-MAX(({TDS_RTI}+IIF({TAX_RTI}<=5000000,0,MIN({TDS_RTI}+{TDS_RTI}*IIF({TAX_RTI}<=10000000,0.10,0.15),IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<60,112500,IIF(MONDIFF([{DOB}],[{PAYDATE}])/12<80,110000,100000))+(IIF({TAX_RTI}<=10000000,5000000,10000000)-1000000)*0.30+({TAX_RTI}-IIF({TAX_RTI}<=10000000,5000000,10000000)))-{TDS_RTI}))-IIF({TAX_RTI}<=350000,MIN({TDS_RTI},2500),0),0)*1.03'
IF @FLD_DATE IS NULL OR @FLD_DATE<@FLD_WEF
	INSERT INTO FORMULA (FIELD_NAME,FLD_DATE,FLD_WEF,FLD_CALC,FLD_VALID,FLD_RND,FLD_RND_M) VALUES
					(@FIELD_NAME,@FLD_WEF,@FLD_WEF,@FLD_CALC,@FLD_VALID,2,1)
ELSE
	UPDATE FORMULA SET FLD_CALC=@FLD_CALC, FLD_VALID=@FLD_VALID WHERE FIELD_NAME=@FIELD_NAME AND FLD_DATE=@FLD_DATE

--SELECT * FROM Formula WHERE Fld_Date='2017-04-01'
--SELECT * FROM Formula WHERE Field_Name='CESS'
--SELECT * FROM Formula WHERE Field_Name IN ('TAX_INCOME','ONETIMEPAY','TOTAL_TAX','TDS','ITAX','SURCH','CESSPM','ADDTAX','TAX_RTI','TDS_RTI') ORDER BY Field_Name,Fld_Date 
--SELECT * FROM PaySetup WHERE Field_Name IN ('TAX_INCOME','ONETIMEPAY','TOTAL_TAX','TDS','ITAX','SURCH','CESSPM','ADDTAX','TAX_RTI','TDS_RTI') ORDER BY SNo
--SELECT * FROM PayHist WHERE Field_Name IN ('TAX_INCOME','ONETIMEPAY','TOTAL_TAX','TDS','ITAX','SURCH','CESSPM','ADDTAX','TAX_RTI','TDS_RTI','SURCHARGE','CESS','TAX_PERMON') AND PayDate='2017-04-30' AND Emp_Code='12143F'
--SELECT * FROM PayHist WHERE Field_Name IN ('TAX_INCOME','ONETIMEPAY','TOTAL_TAX','TDS','ITAX','SURCH','CESSPM','ADDTAX','TAX_RTI','TDS_RTI','SURCHARGE','CESS','TAX_PERMON') AND PayDate='2017-04-30' AND Emp_Code='12147J'
